# 차단 프로필 시스템 (Block Profile System)

## 개요

차단 프로필 시스템은 사용자가 다른 사용자의 프로필을 차단하고 관리할 수 있는 기능을 제공합니다. 이 시스템을 통해 사용자는 불필요한 상호작용을 원치 않는 다른 사용자를 차단하여 더 나은 서비스 경험을 얻을 수 있습니다. 차단된 사용자는 차단한 사용자의 프로필 접근이 제한되며, 사용자는 언제든지 차단을 해제할 수 있습니다.

## 아키텍처

이 시스템은 다음과 같은 구조로 구성되어 있습니다:

```
com.fream.back.domain.user/
├── controller/
│   └── BlockedProfileController.java   # 차단 프로필 관리 API 엔드포인트
├── dto/
│   └── BlockedProfileDto.java          # 차단된 프로필 정보 DTO
├── entity/
│   └── BlockedProfile.java             # 차단 프로필 엔티티
├── repository/
│   └── BlockedProfileRepository.java   # 차단 프로필 데이터 접근 계층
└── service/
    └── BlockProfile/
        ├── BlockedProfileCommandService.java  # 차단 관련 명령 서비스
        └── BlockedProfileQueryService.java    # 차단 관련 조회 서비스
```

## 주요 구성 요소

### 차단 프로필 관리

1. **BlockedProfileController**: 프로필 차단/해제 및 차단 목록 조회를 위한 API 컨트롤러
2. **BlockedProfileCommandService**: 차단 및 차단 해제 기능을 담당하는 서비스
3. **BlockedProfileQueryService**: 차단된 프로필 목록 조회 기능을 담당하는 서비스
4. **BlockedProfileRepository**: 차단 프로필 데이터를 데이터베이스에서 접근하는 레포지토리

### 데이터 객체

1. **BlockedProfileDto**: 차단된 프로필 정보를 담는 DTO (Data Transfer Object)
2. **BlockedProfile**: 차단 관계를 저장하는 엔티티

## 데이터 모델

### 차단 프로필 (BlockedProfile) 엔티티

차단 프로필 엔티티는 다음과 같은 필드를 포함합니다:

- **id**: 차단 관계 ID (PK)
- **profile**: 차단을 설정한 프로필 (Profile 엔티티 참조)
- **blockedProfile**: 차단된 프로필 (Profile 엔티티 참조)
- **created_at**: 차단이 생성된 시간 (BaseTimeEntity에서 상속)
- **updated_at**: 차단이 수정된 시간 (BaseTimeEntity에서 상속)

## API 엔드포인트

### 차단 프로필 관리 API

```
POST /profiles/blocked
```
특정 프로필을 차단합니다.

**요청 본문 예시:**
```json
{
  "blockedProfileId": 123
}
```

**응답 예시:**
```
프로필 차단이 완료되었습니다.
```

```
DELETE /profiles/blocked?blockedProfileId={blockedProfileId}
```
차단된 프로필의 차단을 해제합니다.

**응답 예시:**
```
프로필 차단이 해제되었습니다.
```

```
GET /profiles/blocked
```
현재 인증된 사용자가 차단한 프로필 목록을 조회합니다.

**응답 예시:**
```json
[
  {
    "profileId": 123,
    "profileName": "blocked_user1",
    "profileImageUrl": "profile_123_abc.jpg"
  },
  {
    "profileId": 456,
    "profileName": "spam_account",
    "profileImageUrl": "profile_456_def.jpg"
  }
]
```

## 인증 및 권한

- 모든 API 요청은 사용자 인증이 필요합니다.
- 인증은 SecurityContextHolder에서 현재 인증된 사용자의 이메일을 추출하여 처리합니다.
- 각 사용자는 자신의 차단 목록만 관리할 수 있습니다.

## 비즈니스 로직

### 프로필 차단

1. 인증된 사용자의 이메일로 자신의 프로필을 조회합니다.
2. 차단하려는 프로필 ID로 해당 프로필을 조회합니다.
3. 이미 차단된 프로필인지 확인합니다.
    - 이미 차단되어 있다면 예외를 발생시킵니다.
4. 새로운 BlockedProfile 엔티티를 생성하여 두 프로필 간의 차단 관계를 설정합니다.
5. 생성된 차단 관계를 데이터베이스에 저장합니다.

### 차단 해제

1. 인증된 사용자의 이메일로 자신의 프로필을 조회합니다.
2. 차단 해제하려는 프로필 ID로 해당 프로필을 조회합니다.
3. 현재 사용자가 해당 프로필을 차단한 관계를 조회합니다.
    - 차단 관계가 없다면 예외를 발생시킵니다.
4. 차단 관계를 데이터베이스에서 삭제합니다.

### 차단 목록 조회

1. 인증된 사용자의 이메일로 조회하거나, 프로필 객체로 직접 조회합니다.
2. 차단한 프로필들의 목록을 조회합니다.
3. 각 차단된 프로필의 기본 정보(ID, 이름, 이미지 URL)를 DTO로 변환하여 반환합니다.

## 구현 참고사항

### 개발자를 위한 안내

1. **차단 사유 추가**:
    - 차단 사유를 저장하고 관리하려면 BlockedProfile 엔티티에 reason 필드를 추가할 수 있습니다.
    - 차단 시 사유를 입력받는 DTO를 만들고, API를 수정하여 사유를 처리할 수 있습니다.

2. **상호 차단 관계 처리**:
    - 현재는 단방향 차단만 구현되어 있습니다.
    - A가 B를 차단해도, B는 여전히 A를 차단할 수 있습니다.
    - 필요한 경우 상호 차단 관계를 특별히 처리하는 로직을 추가할 수 있습니다.

3. **차단 목록 페이지네이션**:
    - 차단 목록이 많은 경우 페이지네이션을 구현하여 성능을 개선할 수 있습니다.

### 보안 고려사항

1. **차단 관계 보호**:
    - 차단 관계는 민감한 정보일 수 있으므로, 다른 사용자가 특정 사용자의 차단 목록을 볼 수 없도록 해야 합니다.
    - API 응답에 차단 관계가 노출되지 않도록 주의해야 합니다.

2. **접근 제어**:
    - 차단된 사용자 간의 상호작용을 제한하는 로직을 서비스 전반에 구현해야 합니다.
    - 예: 차단된 사용자가 메시지를 보내거나, 팔로우하거나, 콘텐츠를 볼 수 없도록 합니다.

## 차단 효과 구현

차단 기능의 효과는 다음과 같은 기능에 적용될 수 있습니다:

1. **프로필 조회**: 차단된 사용자의 프로필이 조회 결과에서 제외됩니다.
2. **팔로우/팔로워**: 차단된 사용자는 팔로우할 수 없고, 팔로우/팔로워 목록에서 제외됩니다.
3. **콘텐츠 노출**: 차단된 사용자의 게시물, 댓글 등이 피드나 타임라인에서 제외됩니다.
4. **메시지**: 차단된 사용자와의 메시지 교환이 제한됩니다.

이러한 효과를 구현하려면 각 기능의 서비스 레이어에서 차단 관계를 확인하는 로직을 추가해야 합니다.

## 문제 해결

1. **차단 실패**:
    - 차단하려는 프로필이 존재하는지 확인하세요.
    - 이미 차단된 프로필인지 확인하세요.

2. **차단 해제 실패**:
    - 차단 해제하려는 프로필이 실제로 차단되어 있는지 확인하세요.

3. **인증 오류**:
    - 로그인 상태가 올바른지, SecurityContext에 사용자 정보가 제대로 설정되어 있는지 확인하세요.