# 프로필 시스템 (Profile System)

## 개요

프로필 시스템은 사용자의 프로필 정보를 관리하기 위한 종합적인 모듈입니다. 이 시스템을 통해 사용자는 자신의 프로필 이름, 소개글, 프로필 이미지, 공개 여부 등을 설정할 수 있습니다. 또한 팔로우/팔로워 관계 및 차단된 프로필 목록을 관리합니다. 사용자 계정이 생성될 때 기본 프로필이 자동으로 생성되며, 이후 사용자는 자신의 프로필을 자유롭게 업데이트할 수 있습니다.

## 아키텍처

이 시스템은 다음과 같은 구조로 구성되어 있습니다:

```
com.fream.back.domain.user/
├── controller/
│   └── ProfileController.java       # 프로필 관리 API 엔드포인트
├── dto/
│   ├── ProfileInfoDto.java          # 프로필 정보 출력용 DTO
│   └── ProfileUpdateDto.java        # 프로필 정보 업데이트용 DTO
├── entity/
│   └── Profile.java                 # 프로필 엔티티
├── repository/
│   └── ProfileRepository.java       # 프로필 정보 데이터 접근 계층
└── service/
    └── profile/
        ├── ProfileCommandService.java  # 프로필 생성/수정 서비스
        └── ProfileQueryService.java    # 프로필 조회 서비스
```

## 주요 구성 요소

### 프로필 관리

1. **ProfileController**: 프로필 정보의 조회 및 업데이트를 처리하는 REST API 컨트롤러
2. **ProfileCommandService**: 프로필 생성 및 업데이트 비즈니스 로직을 담당하는 서비스
3. **ProfileQueryService**: 프로필 정보 조회 비즈니스 로직을 담당하는 서비스
4. **ProfileRepository**: 데이터베이스에서 프로필 정보를 접근하는 레포지토리

### 데이터 객체

1. **ProfileInfoDto**: 프로필 정보 출력을 위한 DTO (Data Transfer Object)
2. **ProfileUpdateDto**: 프로필 정보 업데이트를 위한 DTO
3. **BlockedProfileDto**: 차단된 프로필 정보를 위한 DTO
4. **Profile**: 프로필 정보를 저장하는 엔티티

## 데이터 모델

### 프로필 (Profile) 엔티티

프로필 엔티티는 다음과 같은 필드를 포함합니다:

- **id**: 프로필 ID (PK)
- **user**: 프로필 소유 사용자 (User 엔티티 참조, 1:1 관계)
- **profileName**: 프로필 이름 (유니크)
- **Name**: 이름 (실명)
- **bio**: 소개글
- **isPublic**: 프로필 공개 여부
- **profileImageUrl**: 프로필 이미지 파일명
- **followings**: 내가 팔로우한 프로필 목록 (1:N 관계)
- **followers**: 나를 팔로우한 프로필 목록 (1:N 관계)
- **blockedByProfiles**: 나를 차단한 프로필 목록 (1:N 관계)
- **styles**: 프로필에 연결된 스타일 목록 (1:N 관계)

## API 엔드포인트

### 프로필 정보 관리 API

```
GET /profiles
```
현재 인증된 사용자의 프로필 정보를 조회합니다.

**응답 예시:**
```json
{
  "profileId": 1,
  "profileImage": "profile_1_abc123.jpg",
  "profileName": "fashion_lover",
  "realName": "홍길동",
  "email": "user@example.com",
  "bio": "패션을 사랑하는 30대 직장인입니다.",
  "isPublic": true,
  "blockedProfiles": [
    {
      "id": 5,
      "blockedProfileId": 10,
      "blockedProfileName": "bad_user",
      "reason": "스팸 메시지"
    }
  ]
}
```

```
PUT /profiles
```
현재 인증된 사용자의 프로필 정보를 업데이트합니다. multipart/form-data 형식으로 요청해야 합니다.

**요청 예시:**
- Form-data:
    - `profileImage`: (파일) 프로필 이미지 파일
    - `dto`: (JSON)
      ```json
      {
        "profileName": "new_fashion_lover",
        "Name": "김길동",
        "bio": "패션과 예술을 사랑하는 30대 디자이너입니다.",
        "isPublic": true
      }
      ```

**응답 예시:**
```
프로필이 성공적으로 업데이트되었습니다.
```

```
GET /profiles/{profileId}/image
```
지정된 프로필 ID의 프로필 이미지를 조회합니다.

**응답:**
- 이미지 파일의 바이너리 데이터
- Content-Type 헤더에 이미지 유형 정보 포함

## 인증 및 권한

- 모든 API 요청은 사용자 인증이 필요합니다.
- 인증은 SecurityContextHolder에서 현재 인증된 사용자의 이메일을 추출하여 처리합니다.
- 각 사용자는 자신의 프로필 정보만 업데이트할 수 있습니다.

## 비즈니스 로직

### 기본 프로필 생성

1. 사용자 등록 시 `createDefaultProfile` 메서드가 호출됩니다.
2. 랜덤한 10자리 문자열로 프로필 이름을 생성합니다.
3. 기본 프로필 이미지 'user.jpg'를 설정합니다.
4. 사용자 이메일의 아이디 부분(@ 앞부분)을 이름으로 설정합니다.
5. 프로필을 공개 상태로 설정합니다.
6. 생성된 프로필을 사용자와 연결하고 데이터베이스에 저장합니다.

### 프로필 정보 조회

1. 인증된 사용자의 이메일로 프로필을 조회합니다.
2. 프로필 정보와 함께 차단된 프로필 목록을 함께 조회합니다.
3. 조회된 정보를 ProfileInfoDto로 변환하여 반환합니다.

### 프로필 정보 업데이트

1. 인증된 사용자의 이메일로 프로필을 조회합니다.
2. 프로필 이미지가 제공된 경우:
    - 기존 이미지가 기본 이미지('user.jpg')가 아니면 기존 이미지 파일을 삭제합니다.
    - 새 이미지 파일을 저장하고 고유 파일명을 생성합니다.
    - 프로필 엔티티의 profileImageUrl을 업데이트합니다.
3. 제공된 dto의 정보를 바탕으로 프로필 이름, 이름, 소개글, 공개 여부를 업데이트합니다.

## 파일 관리

프로필 이미지 파일은 다음과 같이 관리됩니다:

1. **저장 위치**: `/home/ubuntu/fream/profile_images/`
2. **파일명 형식**: `profile_{profileId}_{random}.확장자`
3. **기본 이미지**: 모든 새 프로필은 기본 이미지 'user.jpg'로 설정됩니다.
4. **이미지 교체**: 프로필 이미지를 변경할 때 기존 이미지(기본 이미지 제외)는 자동으로 삭제됩니다.

## 구현 참고사항

### 개발자를 위한 안내

1. **프로필 이름 유니크 제약조건**:
    - 프로필 이름은 데이터베이스에서 유니크 제약조건이 있으므로, 중복 프로필 이름을 방지하기 위한 로직을 추가해야 할 수 있습니다.

2. **이미지 유형 제한**:
    - 현재는 모든 이미지 타입을 허용하지만, 보안 강화를 위해 허용된 이미지 형식(JPEG, PNG 등)만 업로드하도록 제한하는 것이 좋습니다.

3. **이미지 크기 제한**:
    - 대용량 이미지 업로드를 방지하기 위해 최대 파일 크기 제한을 설정하는 것이 좋습니다.

4. **팔로우/팔로워 기능 확장**:
    - 현재 엔티티에는 팔로우/팔로워 관계가 구현되어 있지만, API에서는 아직 구현되지 않았습니다.
    - 팔로우/언팔로우 API 엔드포인트를 추가할 수 있습니다.

### 보안 고려사항

1. **프로필 이미지 보안**:
    - 업로드된 파일의 MIME 타입 검증을 통해 악성 코드가 포함된 파일 업로드를 방지해야 합니다.
    - 업로드된 이미지 파일에 대한 바이러스 스캔 고려할 수 있습니다.

2. **접근 제어**:
    - 비공개 프로필에 대한 접근 제한 로직을 구현해야 합니다.
    - 차단된 사용자 간의 상호작용을 방지하는 로직을 구현해야 합니다.

## 문제 해결

1. **프로필 이미지 로드 실패**:
    - 파일 시스템 경로가 올바른지 확인하세요.
    - 파일 권한이 적절하게 설정되어 있는지 확인하세요.
    - 파일이 실제로 존재하는지 확인하세요.

2. **프로필 업데이트 실패**:
    - 입력한 프로필 이름이 이미 사용 중인지 확인하세요.
    - 이미지 파일 형식과 크기가 서버 제한에 부합하는지 확인하세요.

3. **인증 오류**:
    - 로그인 상태가 올바른지, SecurityContext에 사용자 정보가 제대로 설정되어 있는지 확인하세요.