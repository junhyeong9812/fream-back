# 은행 계좌 시스템 (Bank Account System)

## 개요

은행 계좌 시스템은 사용자의 판매 정산 계좌 정보를 관리하기 위한 모듈입니다. 이 시스템을 통해 사용자는 자신의 은행 계좌 정보를 등록, 수정, 조회 및 삭제할 수 있습니다. 판매자가 제품을 판매하고 대금을 수령할 때 사용되는 계좌 정보를 안전하게 관리합니다.

## 아키텍처

이 시스템은 다음과 같은 구조로 구성되어 있습니다:

```
com.fream.back.domain.user/
├── controller/
│   └── BankAccountController.java    # 계좌 관리 API 엔드포인트
├── dto/
│   └── BankAccount/
│       ├── BankAccountDto.java       # 계좌 정보 입력용 DTO
│       └── BankAccountInfoDto.java   # 계좌 정보 출력용 DTO
├── entity/
│   └── BankAccount.java              # 계좌 정보 엔티티
├── repository/
│   └── BankAccountRepository.java    # 계좌 정보 데이터 접근 계층
└── service/
    └── bankaccount/
        ├── BankAccountCommandService.java    # 계좌 생성/수정/삭제 서비스
        └── BankAccountQueryService.java      # 계좌 조회 서비스
```

## 주요 구성 요소

### 계좌 관리

1. **BankAccountController**: 계좌 정보의 생성, 조회, 삭제를 처리하는 REST API 컨트롤러
2. **BankAccountCommandService**: 계좌 생성, 수정, 삭제 비즈니스 로직을 담당하는 서비스
3. **BankAccountQueryService**: 계좌 정보 조회 비즈니스 로직을 담당하는 서비스
4. **BankAccountRepository**: 데이터베이스에서 계좌 정보를 접근하는 레포지토리

### 데이터 객체

1. **BankAccountDto**: 계좌 정보 입력을 위한 DTO (Data Transfer Object)
2. **BankAccountInfoDto**: 계좌 정보 출력을 위한 DTO
3. **BankAccount**: 계좌 정보를 저장하는 엔티티

## 데이터 모델

### 은행 계좌 (BankAccount) 엔티티

은행 계좌 엔티티는 다음과 같은 필드를 포함합니다:

- **id**: 계좌 정보 ID (PK)
- **user**: 계좌 소유 사용자 (User 엔티티 참조)
- **bankName**: 은행명
- **accountNumber**: 계좌번호
- **accountHolder**: 예금주 이름
- **created_at**: 레코드 생성 시간 (BaseTimeEntity에서 상속)
- **updated_at**: 레코드 수정 시간 (BaseTimeEntity에서 상속)

## API 엔드포인트

### 계좌 정보 관리 API

```
POST /bank-account
```
계좌 정보를 등록하거나 수정합니다. 사용자당 하나의 계좌 정보만 관리됩니다.

**요청 본문 예시:**
```json
{
  "bankName": "국민은행",
  "accountNumber": "123456-78-901234",
  "accountHolder": "홍길동"
}
```

**응답 예시:**
```
판매 정산 계좌가 성공적으로 등록/수정되었습니다.
```

```
GET /bank-account
```
현재 인증된 사용자의 계좌 정보를 조회합니다.

**응답 예시:**
```json
{
  "bankName": "국민은행",
  "accountNumber": "123456-78-901234",
  "accountHolder": "홍길동"
}
```

```
DELETE /bank-account
```
현재 인증된 사용자의 계좌 정보를 삭제합니다.

**응답 예시:**
```
판매 정산 계좌가 성공적으로 삭제되었습니다.
```

## 인증 및 권한

- 모든 API 요청은 사용자 인증이 필요합니다.
- 인증은 SecurityContextHolder에서 현재 인증된 사용자의 이메일을 추출하여 처리합니다.
- 각 사용자는 자신의 계좌 정보만 접근할 수 있습니다.

## 비즈니스 로직

### 계좌 정보 등록/수정

1. 인증된 사용자의 이메일로 사용자 정보를 조회합니다.
2. 사용자에게 이미 등록된 계좌 정보가 있는지 확인합니다.
3. 등록된 계좌 정보가 없으면 새로운 BankAccount 엔티티를 생성하고 사용자와 연결합니다.
4. 등록된 계좌 정보가 있으면 제공된 정보로 기존 계좌 정보를 업데이트합니다.

### 계좌 정보 조회

1. 인증된 사용자의 이메일로 등록된 계좌 정보를 조회합니다.
2. 등록된 계좌 정보가 없으면 예외를 발생시킵니다.
3. 계좌 정보가 있으면 BankAccountInfoDto로 변환하여 반환합니다.

### 계좌 정보 삭제

1. 인증된 사용자의 이메일로 사용자 정보를 조회합니다.
2. 사용자에게 등록된 계좌 정보가 있는지 확인합니다.
3. 등록된 계좌 정보가 있으면 User 엔티티와의 연결을 해제하고 계좌 정보를 삭제합니다.
4. 등록된 계좌 정보가 없으면 예외를 발생시킵니다.

## 유효성 검증

계좌 정보 등록/수정 시 다음과 같은 유효성 검증이 수행됩니다:

- **은행명**: 비어있지 않아야 합니다.
- **계좌번호**: 비어있지 않아야 하며, 계좌번호 형식에 맞아야 합니다.
- **예금주**: 비어있지 않아야 합니다.

## 구현 참고사항

### 개발자를 위한 안내

1. **계좌 정보 형식 변경**:
    - `BankAccountControllerValidator` 클래스의 유효성 검증 로직을 수정하여 다양한 은행의 계좌번호 형식을 지원할 수 있습니다.

2. **추가 필드 확장**:
    - 필요한 경우 다음과 같은 추가 필드를 구현할 수 있습니다:
        - 계좌 사용 목적 (예: 판매대금, 환불계좌 등)
        - 계좌 활성화 상태
        - 계좌 인증 상태

### 보안 고려사항

1. **계좌 정보 보호**:
    - 계좌번호는 민감한 개인정보이므로 데이터베이스에 저장 시 암호화를 고려해야 합니다.
    - API 응답에서 계좌번호 일부를 마스킹 처리하는 것이 좋습니다.

2. **접근 제어**:
    - 각 사용자는 자신의 계좌 정보만 접근할 수 있도록 구현되어 있습니다.
    - 관리자 권한이 필요한 경우 별도의 인증 및 권한 확인 로직을 추가해야 합니다.

## 문제 해결

1. **계좌 정보 등록 실패**: 입력한 계좌 정보가 유효성 검증을 통과했는지 확인하세요.

2. **계좌 정보 조회 불가**: 사용자에게 등록된 계좌 정보가 있는지 확인하세요.

3. **인증 오류**: 로그인 상태가 올바른지, SecurityContext에 사용자 정보가 제대로 설정되어 있는지 확인하세요.